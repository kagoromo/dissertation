\newcommand{\DefEqStore}{
\begin{definition}\label{def:eqstore}
  Two stores $S$ and $S'$ are \emph{equal} iff:
  \begin{enumerate}
    \item $S = \topS$ and $S' = \topS$, or
    \item $\dom{S} = \dom{S'}$ and for all $l \in \dom{S}$, $S(l) =
      S'(l)$.
  \end{enumerate}
\end{definition}
}

\newcommand{\DefLeqStore}{
\begin{definition}\label{def:leqstore}
  A store $S$ is \emph{less than or equal to} a store $S'$ (written
  $\leqstore{S}{S'}$) iff:
  \begin{itemize}
  \item $S' = \topS$, or
  \item $\dom{S} \subseteq \dom{S'}$ and for all $l
    \in \dom{S}$, $S(l) \myleq S'(l)$.
  \end{itemize}
\end{definition}
}

\newcommand{\DefLubStore}{
\begin{definition}\label{def:store-lub}

  The \emph{least upper bound (lub)} of two stores $S_1$ and $S_2$ (written
  $\lubstore{S_1}{S_2}$) is defined as follows:
  
  \begin{itemize}
  \item $\lubstore{S_1}{S_2} = \topS$ iff there exists some $l \in
    \dom{S_1} \cap \dom{S_2}$ such that $\lub{S_1(l)}{S_2(l)} = \top$.
  \item Otherwise, $\lubstore{S_1}{S_2}$ is the store $S$ such that:

  \begin{itemize}
  \item $\dom{S} = \dom{S_1} \cup \dom{S_2}$, and
  \item For all $l \in \dom{S}$:
  \end{itemize}
    \begin{displaymath}
      S(l) = \left\{ \begin{array}{ll}
        \lub{S_1(l)}{S_2(l)} & \textrm{if $l \in \dom{S_1} \cap \dom{S_2}$} \\
        S_1(l) & \textrm{if $l \notin \dom{S_2}$} \\
        S_2(l) & \textrm{if $l \notin \dom{S_1}$}
        \end{array} \right.
    \end{displaymath}
  \end{itemize}
\end{definition}
}

\newcommand{\DefLeqStoreCnC}{
\begin{definition}[store ordering, Featherweight CnC]\label{def:leqstore-cnc}
  A store $S$ is \emph{less than or equal to} a store $S'$ (written
  $\leqstore{S}{S'}$) iff $\dom{S} \subseteq \dom{S'}$ and for all $l
  \in \dom{S}$, $S(l) = S'(l)$.
\end{definition}
}

\newcommand{\DefNonConflicting}{
\begin{definition}\label{def:non-conflicting}
  A store $S''$ is \emph{non-conflicting} with the transition
  $\config{S}{e} \parstepsto \config{S'}{e'}$ iff $(\dom{S'} -
  \dom{S}) \cap \dom{S''} = \emptyset$.
\end{definition}
}

\newcommand{\DefRenaming}{
\begin{definition}\label{def:renaming}
  A \emph{renaming} of a configuration $\config{S}{e}$ is the
  substitution into $\config{S}{e}$ of location names $l'_1, \dots,
  l'_n$ for some subset $l_1, \dots, l_n$ of $\dom{S}$.
\end{definition}
}

\newcommand{\DefSafeRenaming}{
\begin{definition}\label{def:safe-renaming}
  A \emph{safe renaming of $\config{S'}{e'}$ with respect to
    $\config{S}{e} \parstepsto \config{S'}{e'}$} is a renaming of
  $\config{S'}{e'}$ in which the locations $l_1, \dots, l_n$ being
  renamed are the members of the set $\dom{S'} - \dom{S}$, and the
  names $l'_1, \dots, l'_n$ that are replacing $l_1, \dots, l_n$ do
  not appear in $\dom{S'}$.
\end{definition}
}

\newcommand{\DefRename}{
\begin{definition}\label{def:rename}
  The $\mathit{rename}$ metafunction is defined as follows:
  \[
  \begin{array}{lcl}
    \renamelocs{\cdot}{\cdot}{\cdot} & : &\conf \times S \times S \rightarrow \conf \\
    \renamelocs{\config{S'}{e}}{S''}{S} & \defeq & \subst{\config{S'}{e}}{l_1}{l'_1} \dots [l_n := l'_n]
  \end{array}
  \]
  where:
  \begin{itemize}
  \item $\lbrace l_1, \dots, l_n \rbrace = \dom{S'} - \dom{S}$, and
  \item $\lbrace l'_1, \dots, l'_n \rbrace $ is a set such that $l'_i
    \notin (\dom{S'} \cup \dom{S''})$ for $i \in [1..n]$.
  \end{itemize}
\end{definition}
}

\newcommand{\LemLocRenaming}{
\begin{lem}[Renaming of Locations During a Step]\label{lem:loc-renaming}

  If $\config{S}{e} \parstepsto \config{S'}{e'}$ (where
  $\config{S'}{e'} \neq \textup{\error}$) and $\lbrace l_1, \dots, l_n
  \rbrace = \dom{S'} - \dom{S}$, then:

  For all sets \lk{(including the empty set)} $\lbrace l'_1, \dots,
  l'_n \rbrace$ such that $l'_i \notin \dom{S'}$ for $i \in [1..n]$:
  \begin{displaymath}
    \begin{split}
      &\config{S}{e} \parstepsto 
      \\
      &\config{\extS{\Soldlocs}{l'_1}{S'(l_1)} \dots [\storebinding{l'_n}{S'(l_n)}]}
      {\subst{e'}{l_1}{l'_1} \dots [l_n := l'_n]} \\
      &\mbox{($\neq \textup{\error}$)},
    \end{split}
  \end{displaymath}
  where $\Soldlocs$ is defined as follows: $\dom{\Soldlocs} =
  \dom{S}$, and for all $l \in \dom{\Soldlocs}$, $\Soldlocs(l) =
  S'(l)$.
\end{lem}
}

\newcommand{\LemRenamingAfterAStep}{
\begin{lem}[Renaming of Locations After a Step]\label{lem:renaming-after-a-step}

  If $\config{S}{e} \parstepsto \config{S'}{e'}$ (where
  $\config{S'}{e'} \neq \textup{\error}$) and $\lbrace l_1, \dots, l_n
  \rbrace = \dom{S'} - \dom{S}$, then:

  For all sets \lk{(including the empty set)} $\lbrace l'_1, \dots,
  l'_n \rbrace$ such that $l'_i \notin \dom{S'}$ for $i \in [1..n]$:
  \begin{displaymath}
    \begin{split}
      &\config{S'}{e'} \parstepsto 
      \\
      &\config{\extS{\Soldlocs}{l'_1}{S'(l_1)} \dots [\storebinding{l'_n}{S'(l_n)}]}
      {\subst{e'}{l_1}{l'_1} \dots [l_n := l'_n]} \\
      &\mbox{($\neq \textup{\error}$)},
    \end{split}
  \end{displaymath}
  where $\Soldlocs$ is defined as follows: $\dom{\Soldlocs} =
  \dom{S}$, and for all $l \in \dom{\Soldlocs}$, $\Soldlocs(l) =
  S'(l)$.
\end{lem}
}

\newcommand{\LemSafetyOfRename}{
\begin{lem}[Safety of $\mathit{rename}$]\label{lem:safety-of-rename}
  If $\config{S}{e} \parstepsto \config{S'}{e'}$ (where
  $\config{S'}{e'} \neq \textup{\error}$) and $S'' \neq \topS$, then:

  $\config{S}{e} \parstepsto \renamelocs{\config{S'}{e'}}{S''}{S}$.
\end{lem}
}

\newcommand{\LemIndependence}{
\begin{lem}[Independence]\label{lem:pres-eval}
  If $\config{S}{e} \parstepsto \config{S'}{e'}$ (where
  $\config{S'}{e'} \neq \textup{\error}$), then for all $S''$ such
  that $S''$ is non-conflicting with $\config{S}{e} \parstepsto
  \config{S'}{e'}$ and $\lubstore{S'}{S''} \neq \topS$:

  $\config{\lubstore{S}{S''}}{e} \parstepsto \config{\lubstore{S'}{S''}}{e'}$.
\end{lem}
}

\newcommand{\LemClash}{
\begin{lem}[Clash]\label{lem:error-lub}
  If $\config{S}{e} \parstepsto \config{S'}{e'}$ (where
  $\config{S'}{e'} \neq \textup{\error}$), then for all $S''$ such
  that $S''$ is non-conflicting with $\config{S}{e} \parstepsto
  \config{S'}{e'}$ and $\lubstore{S'}{S''} = \topS$:

  $\config{\lubstore{S}{S''}}{e} \parstepsto \textup{\error}$.
\end{lem}
}

\newcommand{\LemStorePartition}{
\begin{lem}[Store Partition]\label{lem:store-partition}
  Let $S$ and $S'$ be stores.  Then, for all $l_i$ such that $S(l_i)
  \mylt S'(l_i)$, there exists $S''$ such that
  $\eqstore{S'}{\extS{S''}{l_i}{S'(l_i)}}$ and $\myltstore{S''}{S'}$.
\end{lem}
}

\newcommand{\LemErrorPreservation}{
\begin{lem}[Error Preservation]\label{lem:error-preservation}
  If $\config{S}{e} \parstepsto \textup{\error}$ and $\leqstore{S}{S'}$, then
  $\config{S'}{e} \parstepsto \textup{\error}$.

\end{lem}
}

\newcommand{\LemDiamond}{
\begin{lem}[Diamond]\label{lem:diamond}
  If $\conf \parstepsto \conf_a$ and $\conf \parstepsto \conf_b$,
  then there exists $\conf_c$ such that either:
  \begin{itemize}
    \item $\conf_a \parstepsto \conf_c$ and $\conf_b \parstepsto \conf_c$, or
    \item there exists a safe renaming $\conf_b'$ of $\conf_b$ with
      respect to $\conf \parstepsto \conf_b$, such that $\conf_a
      \parstepsto \conf_c$ and $\conf_b' \parstepsto \conf_c$.
  \end{itemize}
\end{lem}
}

\newcommand{\LemStrongLocalConfluence}{
\begin{cor}[Strong Local Confluence]\label{cor:strong-local-confluence}
  If $\conf \parstepsto \conf'$ and $\conf \parstepsto \conf''$,
  then there exist $\conf_c, i, j$ such that $\conf' \parstepsto^i
  \conf_c$ and $\conf'' \parstepsto^j \conf_c$ and $i \leq 1$ and
  $j \leq 1$.
\end{cor}
\begin{proof}
  Choose $i = j = 1$.  The proof follows immediately from
  Lemma~\ref{lem:diamond}.
\end{proof}
}

\newcommand{\LemStrongOneSidedConfluence}{
\begin{lem}[Strong One-Sided Confluence]\label{lem:strong-one-sided-confluence}
  If $\conf \parstepsto \conf'$ and $\conf \parstepsto^m \conf''$,
  where $1 \leq m$, then there exist $\conf_c, i, j$ such that
  $\conf' \parstepsto^i \conf_c$ and $\conf'' \parstepsto^j
  \conf_c$ and $i \leq m$ and $j \leq 1$.
\end{lem}
}

\newcommand{\LemStrongConfluence}{
\begin{lem}[Strong Confluence]\label{lem:strong-confluence}
  If $\conf \parstepsto^n \conf'$ and $\conf \parstepsto^m
  \conf''$, where $1 \leq n$ and $1 \leq m$, then there exist
  $\conf_c, i, j$ such that $\conf' \parstepsto^i \conf_c$ and
  $\conf'' \parstepsto^j \conf_c$ and $i \leq m$ and $j \leq n$.
\end{lem}
}

\newcommand{\LemConfluence}{
\begin{lem}[Confluence]\label{lem:confluence}
  If $\conf \parstepsto^* \conf'$ and $\conf \parstepsto^*
  \conf''$, then there exists $\conf_c$ such that $\conf'
  \parstepsto^* \conf_c$ and $\conf'' \parstepsto^* \conf_c$.
\end{lem}
\begin{proof}
  Strong Confluence (Lemma~\ref{lem:strong-confluence}) implies
  Confluence.
\end{proof}
}

\newcommand{\ThmDeterminism}{
\begin{thm}[Determinism]\label{thm:determinism}
  If $\conf \parstepsto^* \conf'$ and $\conf \parstepsto^*
  \conf''$, and neither $\conf'$ nor $\conf''$ can take a step
  except by {\sc E-Refl} or {\sc E-ReflErr}, then $\conf' =
  \conf''$.
\end{thm}
\begin{proof}
  We have from Lemma~\ref{lem:confluence} that there exists $\conf_c$
  such that $\conf' \parstepsto^* \conf_c$ and $\conf''
  \parstepsto^* \conf_c$.  Since $\conf'$ and $\conf''$ can only
  step to themselves, we must have $\conf' = \conf_c$ and $\conf''
  = \conf_c$, hence $\conf' = \conf''$.
\end{proof}
}
