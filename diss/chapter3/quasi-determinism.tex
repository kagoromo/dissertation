\section{Proof of quasi-determinism for $\lambdaLVish$}\label{s:quasi-quasi-determinism}

In this section, I give a proof of quasi-determinism for
$\lambdaLVish$ that formalizes the claim made earlier in this chapter:
that, for a given program, although some executions may raise
exceptions, all executions that produce a final result will produce
the same final result.

The quasi-determinism theorem says that if two executions starting
from a configuration $\conf$ terminate in configurations $\conf'$ and
$\conf''$, then either $\conf'$ and $\conf''$ are the same
configuration, or one of them is $\error$.  As with the determinism
result for $\lambdaLVar$, quasi-determinism follows from a series of
supporting lemmas which I first prove.  Unlike with the determinism
proof for $\lambdaLVar$, though, for $\lambdaLVish$ I do not need to
prove a Clash lemma (\eg, Lemma~\ref{lem:lvars-clash}) or an Error
Preservation lemma (\eg, Lemma~\ref{lem:lvars-error-preservation}).
These properties aren't necessary because quasi-determinism, with its
``...or one of them is $\error$'', is a weaker property than
determinism.

\subsection{Monotonicity lemma}\label{subsection:quasi-monotonicity}

The Monotonicity lemma says that, as evaluation proceeds according to
the $\parstepsto$ relation, the store can only grow with respect to
the $\leqstore{}{}$ ordering.

\LemMonotonicity
\begin{proof}
  By induction on the derivation of $\config{S}{e} \parstepsto
  \config{S'}{e'}$, by cases on the last rule in the derivation; see
  Section~\ref{section:monotonicity-proof}.
\end{proof}

\subsection{Independence lemma}\label{subsection:quasi-independence}

Like the Independence lemma for $\lambdaLVar$
(Lemma~\ref{lem:lvars-independence}), Lemma~\ref{lem:independence}
establishes a ``frame property'' for $\lambdaLVish$ that captures the
idea that independent effects commute with each other.  Just as with
the $\lambdaLVar$ version of the Independence lemma,
Lemma~\ref{lem:independence} requires as a precondidion that the store
$S''$ must be \emph{non-conflicting}
(Definition~\ref{def:lvars-non-conflicting}) with the original
transition from $\config{S}{e}$ to $\config{S'}{e'}$, meaning that
locations in $S''$ cannot share names with locations newly allocated
during the transition, which rules out location name conflicts caused
by allocation.

In the context of $\lambdaLVish$, where freezing is possible, we have
an additional precondition that the stores $\lubstore{S'}{S''}$ and
$S$ are \emph{equal in status}---that, for all the locations shared
between them, the status bits of those locations agree.  This
assumption rules out interference from freezing.

\DefEqualStatus

\LemIndependence
\begin{proof}
   By induction on the derivation of $\config{S}{e} \parstepsto
   \config{S'}{e'}$, by cases on the last rule in the derivation; see
   Section~\ref{section:independence-proof}.
\end{proof}

\subsection{Quasi-confluence lemmas}\label{subsection:quasi-quasi-confluence}

\TODO{Add some explanatory text here.}

\lk{In the POPL paper and TR, there was a lemma called ``Strong Local
  Quasi-Diamond'', and another, almost identical one called ``Strong
  Local Quasi-Confluence'' that followed almost directly from Strong
  Local Quasi-Diamond.  Here I combine them into a single lemma and
  call it Strong Local Quasi-Confluence.  I don't want to use the word
  "diamond", since to a lot of people that connotes "exactly one step
  on each side of the diamond", which isn't true for this language
  (that is, sometimes it's zero steps).  The only reason we were using
  the word ``diamond'' was because it was an artifact of the
  determinism proof in the original FHPC paper, which in turn was an
  artifact of the CnC paper---see
  Section~\ref{subsection:lvars-confluence} for more commentary on
  that.}

\LemStrongLocalQuasiConfluence
\begin{proof}
  By induction on the derivation of $\conf \parstepsto \conf_a$, by
  cases on the last rule in the derivation; see
  Section~\ref{section:strong-local-quasi-confluence-proof}.
  \TODO{Figure out if this is a correct summary.}
\end{proof}

\LemStrongOneSidedQuasiConfluence
\begin{proof}
  By induction on $m$; see
  Section~\ref{section:strong-one-sided-quasi-confluence-proof}.
  \TODO{Figure out if this is a correct summary.}
\end{proof}

\LemStrongQuasiConfluence
\begin{proof}
  By induction on $n$; see
  Section~\ref{section:strong-quasi-confluence-proof}.
  \TODO{Figure out if this is a correct summary.}
\end{proof}

\LemQuasiConfluence
 
\subsection{Quasi-determinism theorem}\label{subsection:quasi-quasi-determinism}

\TODO{Add some explanatory text here.}

\ThmQuasiDeterminism
