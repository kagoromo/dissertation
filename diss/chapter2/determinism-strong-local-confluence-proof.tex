\begin{proof}
  Suppose $\conf \ctxstepsto \conf_a$ and $\conf \ctxstepsto \conf_b$.
  We have to show that there exist $\conf_c, i, j, \pi_a, \pi_b$ such
  that $\pi_a(\conf) = \pi_b(\conf) = \conf$ and $\pi_a(\conf_a)
  \ctxstepsto^i \conf_c$ and $\pi_b(\conf_b) \ctxstepsto^j \conf_c$
  and $i \leq 1$ and $j \leq 1$.

  By inspection of the operational semantics, it must be the case that
  $\conf$ steps to $\conf_a$ by the {\sc E-Eval-Ctxt} rule.  Let
  $\conf = \config{S}{\evalctxt{E_a}{e_{a_1}}}$ and let $\conf_a =
  \config{S_a}{\evalctxt{E_a}{e_{a_2}}}$.

  Likewise, it must be the case that $\conf$ steps to $\conf_b$ by the
  {\sc E-Eval-Ctxt} rule.  Let $\conf =
  \config{S}{\evalctxt{E_b}{e_{b_1}}}$ and let $\conf_b =
  \config{S_b}{\evalctxt{E_b}{e_{b_2}}}$.

  Note that $\conf = \config{S}{\evalctxt{E_a}{e_{a_1}}} =
  \config{S}{\evalctxt{E_b}{e_{b_1}}}$, and so
  $\evalctxt{E_a}{e_{a_1}} = \evalctxt{E_b}{e_{b_1}}$, but $E_a$ and
  $E_b$ may differ and $e_{a_1}$ and $e_{b_1}$ may differ.

  Since $\config{S}{\evalctxt{E_a}{e_{a_1}}} \ctxstepsto
  \config{S_a}{\evalctxt{E_a}{e_{a_2}}}$ and
  $\config{S}{\evalctxt{E_b}{e_{b_1}}} \ctxstepsto
  \config{S_b}{\evalctxt{E_b}{e_{b_2}}}$ and $\evalctxt{E_a}{e_{a_1}}
  = \evalctxt{E_b}{e_{b_1}}$, we have from
  Lemma~\ref{lem:lvars-locality} (Locality) that there exist
  evaluation contexts $E'_a$ and $E'_b$ such that:

  \begin{itemize}
  \item $\evalctxt{E'_a}{e_{a_1}} = \evalctxt{E_b}{e_{b_2}}$, and
  \item $\evalctxt{E'_b}{e_{b_1}} = \evalctxt{E_a}{e_{a_2}}$, and
  \item $\evalctxt{E'_a}{e_{a_2}} =
  \evalctxt{E'_b}{e_{b_2}}$.
  \end{itemize}

  Let $\Delta_a = \dom{S_a} - \dom{S}$, and let $\Delta_b = \dom{S_b}
  - \dom{S}$.

  Suppose $\Delta_a = \setof{l_1, \dots, l_n}$.  Let $L = \setof{l'_1,
    \dots, l'_n}$ such that $l'_i \notin (\dom{S_a} \cup \dom{S_b})$.

  Suppose $\Delta_b = \setof{m_1, \dots, m_k}$.  Let $M = \setof{m'_1,
    \dots, m'_k}$ such that $m'_i \notin (\dom{S_a} \cup \dom{S_b}
  \cup L)$.

  Let $\pi_a = \setof{(l_1, l'_1), \dots, (l_n, l'_n)}$.

  Let $\pi_b = \setof{(m_1, m'_1), \dots, (m_k, m'_k)}$.

  Since $\Delta_a \cap \dom{S} = \emptyset$, we know that $\pi_a(S) = S$.

  Since $\Delta_b \cap \dom{S} = \emptyset$, we know that $\pi_b(S) = S$.

  Since the only locations occurring in $\evalctxt{E_a}{e_{a_1}}$ are
  in $\dom{S}$, $\pi_a(e_{a_1}) = e_{a_1}$, and likewise, since the
  only locations occurring in $\evalctxt{E_b}{e_{b_1}}$ are in
  $\dom{S}$, $\pi_b(e_{b_1}) = e_{b_1}$. Hence $\pi_a(\conf) =
  \pi_b(\conf) = \conf$.

  \lk{Not yet sure how to use all this -- I'm just writing down all
    the facts we know.}

  We have that $\config{S}{\evalctxt{E_a}{e_{a_1}}} \ctxstepsto
  \config{S_a}{\evalctxt{E_a}{e_{a_2}}}$.  Hence, from the premise of
  {\sc E-Eval-Ctxt}, we have that $\config{S}{e_{a_1}}
  \parstepsto \config{S_a}{e_{a_2}}$.

  Hence, by Lemma~\ref{lem:lvars-permutability} (Permutability),
  $\pi_a(\config{S}{e_{a_1}}) \parstepsto
  \pi_a(\config{S_a}{e_{a_2}})$.

  Since $\pi_a(S) = S$ and $\pi_a(e_{a_1}) = e_{a_1}$,
  $\config{S}{e_{a_1}} \parstepsto \pi_a(\config{S_a}{e_{a_2}})$.  By
  Definition~\ref{def:lvars-permuation-configuration},
  $\pi_a(\config{S_a}{e_{a_2}}) =
  \config{\pi_a(S_a)}{\pi_a(e_{a_2})}$, so we have that
  $\config{S}{e_{a_1}} \parstepsto
  \config{\pi_a(S_a)}{\pi_a(e_{a_2})}$.

  We have that $\config{S}{\evalctxt{E_b}{e_{b_1}}} \ctxstepsto
  \config{S_b}{\evalctxt{E_b}{e_{b_2}}}$.  Hence, from the premise of
  {\sc E-Eval-Ctxt}, we have that $\config{S}{e_{b_1}}
  \parstepsto \config{S_b}{e_{b_2}}$.

  Hence, by Lemma~\ref{lem:lvars-permutability} (Permutability),
  $\pi_b(\config{S}{e_{b_1}}) \parstepsto
  \pi_b(\config{S_b}{e_{b_2}})$.

  Since $\pi_b(S) = S$ and $\pi_b(e_{b_1}) = e_{b_1}$,
  $\config{S}{e_{b_1}} \parstepsto \pi_b(\config{S_b}{e_{b_2}})$.  By
  Definition~\ref{def:lvars-permuation-configuration},
  $\pi_b(\config{S_b}{e_{b_2}}) =
  \config{\pi_b(S_b)}{\pi_b(e_{b_2})}$, so we have that
  $\config{S}{e_{b_1}} \parstepsto
  \config{\pi_b(S_b)}{\pi_b(e_{b_2})}$.

  \lk{More facts:}

  Furthermore, we know that $\pi_a(S_a)$ is non-conflicting with
  $\config{S}{e_{b_1}} \parstepsto
  \config{\pi_b(S_b)}{\pi_b(e_{b_2})}$.  To see why, assume that there
  exists an $l \in (\dom{\pi_b(S_b)}) - \dom{S}) \cup
  \dom{\pi_a(S_a)}$.  Then $l \in (\dom{\pi_b(S_b)} - \dom{S})$ and $l
  \in \dom{\pi_a(S_a)}$.  Hence $l = l'_i$ for some $l'_i \in L$,
  since $l \in \dom{\pi_a(S_a)}$.  But since $l \in (\dom{\pi_b(S_b)}
  - \dom{S})$, we know that $l \in M$, which is a contradiction since
  it implies that $l \notin L$.

  Symmetrically, we know that $\pi_b(S_b)$ is non-conflicting with
  $\config{S}{e_{a_1}} \parstepsto
  \config{\pi_a(S_a)}{\pi_a(e_{a_2})}$.  To see why, assume that there
  exists an $l \in (\dom{\pi_a(S_a)}) - \dom{S}) \cup
  \dom{\pi_b(S_b)}$.  Then $l \in (\dom{\pi_a(S_a)} - \dom{S})$ and $l
  \in \dom{\pi_b(S_b)}$.  Hence $l = l'_i$ for some $l'_i \in L$,
  since $l \in (\dom{\pi_a(S_a)} - \dom{S})$.  But since $l \in
  \dom{\pi_b(S_b)}$, we know that $l \in M$, which is a contradiction
  since it implies that $l \notin L$.


  Now, consider whether $\lubstore{\pi_a(S_a)}{\pi_b(S_b)} = \topS$.

  \begin{itemize}
  \item Case $\lubstore{\pi_a(S_a)}{\pi_b(S_b)} \neq \topS$:

    Since $\pi_a(S_a)$ is non-conflicting with $\config{S}{e_{b_1}}
    \parstepsto \config{\pi_b(S_b)}{\pi_b(e_{b_2})}$ and
    $\lubstore{\pi_a(S_a)}{\pi_b(S_b)} \neq \topS$, we have by
    Lemma~\ref{lem:lvars-independence} (Independence) that:

    $\config{\lubstore{S}{\pi_a(S_a)}}{e_{b_1}} \parstepsto
    \config{\lubstore{\pi_b(S_b)}{\pi_a(S_a)}}{\pi_b(e_{b_2})}$.

    Hence by {\sc E-Eval-Ctxt}, using the context $\pi_b(E'_b)$, we have that:

    $\config{\lubstore{S}{\pi_a(S_a)}}{\evalctxt{(\pi_b(E'_b))}{e_{b_1}}}
    \ctxstepsto
    \config{\lubstore{\pi_b(S_b)}{\pi_a(S_a)}}{\evalctxt{(\pi_b(E'_b))}{\pi_b(e_{b_2})}}$.

    Since $e_{b_1} = \pi_b(e_{b_1})$ and $S = \pi_a(S)$ and
    $\lubstore{S}{S_a} = S_a$, we have that:

    $\config{\pi_a(S_a)}{\pi_b(\evalctxt{E'_b}{e_{b_1}})} \ctxstepsto
    \config{\lubstore{\pi_b(S_b)}{\pi_a(S_a)}}{\pi_b(\evalctxt{E'_b}{e_{b_2}})}$.

    \lk{Again, this is slightly different from what we need. :( And I'm
      not sure if it's wrong to have a permutation on the context...}

    Since $\pi_b(S_b)$ is non-conflicting with $\config{S}{e_{a_1}}
    \parstepsto \config{\pi_a(S_a)}{\pi_a(e_{a_2})}$ and
    $\lubstore{\pi_a(S_a)}{\pi_b(S_b)} \neq \topS$, we have by
    Lemma~\ref{lem:lvars-independence} (Independence) that:

    $\config{\lubstore{S}{\pi_b(S_b)}}{e_{a_1}} \parstepsto
    \config{\lubstore{\pi_a(S_a)}{\pi_b(S_b)}}{\pi_a(e_{a_2})}$.

    Hence by {\sc E-Eval-Ctxt}, using the context $\pi_a(E'_a)$, we
    have that:

    $\config{\lubstore{S}{\pi_b(S_b)}}{\evalctxt{(\pi_a(E'_a))}{e_{a_1}}}
    \ctxstepsto
    \config{\lubstore{\pi_a(S_a)}{\pi_b(S_b)}}{\evalctxt{(\pi_a(E'_a))}{\pi_a(e_{a_2})}}$.

    Since $e_{b_1} = \pi_b(e_{b_1})$ and $S = \pi_b(S)$ and
    $\lubstore{S}{S_b} = S_b$, we have that:

    $\config{\pi_b(S_b)}{\pi_a(\evalctxt{E'_a}{e_{a_1}})} \ctxstepsto
    \config{\lubstore{\pi_a(S_a)}{\pi_b(S_b)}}{\pi_a(\evalctxt{E'_a}{e_{a_2}})}$.

    \lk{Again, this is slightly different from what we need. :( And
      I'm not sure if it's wrong to have a permutation on the
      context...}

    \lk{OK, finally ready to pick a $\conf_c$.  But not sure if it
      should be $\evalctxt{E'_a}{e_{a_2}}$ or something like
      $\pi_a(\pi_b(\evalctxt{E'_a}{e_{a_2}}))$ or what.}

    Then, choose $\conf_c =
    \config{\lubstore{\pi_a(S_a)}{\pi_b(S_b)}}{\evalctxt{E'_a}{e_{a_2}}}$,
    $i = 1$, and $j = 1$.

    To show:
    \begin{itemize}
    \item $\pi_a(\config{S_a}{\evalctxt{E_a}{e_{a_2}}}) \ctxstepsto
      \config{\lubstore{\pi_a(S_a)}{\pi_b(S_b)}}{\evalctxt{E'_a}{e_{a_2}}}$,
      and
    \item $\pi_b(\config{S_b}{\evalctxt{E_b}{e_{b_2}}}) \ctxstepsto
      \config{\lubstore{\pi_a(S_a)}{\pi_b(S_b)}}{\evalctxt{E'_a}{e_{a_2}}}$.
    \end{itemize}

    Since 
    $\evalctxt{E'_a}{e_{a_1}} = \evalctxt{E_b}{e_{b_2}}$, and
    $\evalctxt{E'_b}{e_{b_1}} = \evalctxt{E_a}{e_{a_2}}$, and
    $\evalctxt{E'_a}{e_{a_2}} =
    \evalctxt{E'_b}{e_{b_2}}$, it suffices to show that:

    \begin{itemize}
    \item $\pi_a(\config{S_a}{\evalctxt{E'_b}{e_{b_1}}}) \ctxstepsto
      \config{\lubstore{\pi_a(S_a)}{\pi_b(S_b)}}{\evalctxt{E'_b}{e_{b_2}}}$,
      and
    \item $\pi_b(\config{S_b}{\evalctxt{E'_a}{e_{a_1}}}) \ctxstepsto
      \config{\lubstore{\pi_a(S_a)}{\pi_b(S_b)}}{\evalctxt{E'_a}{e_{a_2}}}$.
    \end{itemize}

  \item Case $\lubstore{\pi_a(S_a)}{\pi_b(S_b)} = \topS$: \TODO{finish
    case.}
  \end{itemize}

  \lk{I think we also still have to separately deal with cases where
    $\conf_a = \error$ or $\conf_b = \error$.}
\end{proof}
