\newcommand{\LemPartitionOfDp}{
\begin{lem}[Partition of $D_p$]\label{lem:partition-of-Dp}
Suppose $(D, \userleq, \bot, \top)$ is a lattice, and that $(D_p,
\leqp, \botp, \topp) = \Freeze{D, \userleq, \bot, \top}$, and let $X =
D - \setof{\top}$.  Then every member of $D_p$ is either
\begin{itemize}
  \item $(d, \textup{\frozenfalse})$, with $d \in D$, or
  \item $(x, \textup{\frozentrue})$, with $x \in X$.
\end{itemize}
\end{lem}
\begin{proof}
  Immediate from Definition~\ref{def:lattice-with-status-bits}.
\end{proof}
}

\newcommand{\LemLatticeStructure}{
\begin{lem}[Lattice structure]\label{lem:lattice-structure}
Suppose that $(D, \userleq, \bot, \top)$ is a lattice, and that $(D_p,
\leqp, \botp, \topp) = \Freeze{D, \userleq, \bot, \top}$. Then:

\begin{enumerate}
  \item $\leqp$ is a partial order over $D_p$.
   
  \item Every nonempty finite subset of $D_p$ has a least upper bound.

  \item $\botp$ is the least element of $D_p$.

  \item $\topp$ is the greatest element of $D_p$.
\end{enumerate}

Therefore $(D_p, \leqp, \botp, \topp)$ is a lattice.
\end{lem}
}

\newcommand{\LemPermutability}{
\begin{lem}[Permutability]\label{lem:permutability}
  For any finite permutation $\pi$,
  \begin{enumerate}
  \item \label{thm:quasi-permutable-reduction-transitions} $\conf
    \parstepsto \conf'$ if and only if $\pi(\conf) \parstepsto
    \pi(\conf')$.
  \item \label{thm:quasi-permutable-context-transitions} $\conf
    \ctxstepsto \conf'$ if and only if $\pi(\conf) \ctxstepsto
    \pi(\conf')$.
  \end{enumerate}
\end{lem}
}

\newcommand{\LemLocality}{
\begin{lem}[Locality]\label{lem:locality}
  If $\config{S}{\evalctxt{E_1}{e_1}} \ctxstepsto
  \config{S_1}{\evalctxt{E_1}{e'_1}}$ and
  $\config{S}{\evalctxt{E_2}{e_2}} \ctxstepsto
  \config{S_2}{\evalctxt{E_2}{e'_2}}$ and $\evalctxt{E_1}{e_1} =
  \evalctxt{E_2}{e_2}$, then there exist evaluation contexts $E'_1$
  and $E'_2$ such that:
  \begin{itemize}
  \item $\evalctxt{E'_1}{e_1} = \evalctxt{E_2}{e'_2}$, and
  \item $\evalctxt{E'_2}{e_2} = \evalctxt{E_1}{e'_1}$, and
  \item $\evalctxt{E'_1}{e'_1} = \evalctxt{E'_2}{e'_2}$.
  \end{itemize}
\end{lem}
}

\newcommand{\LemMonotonicity}{
\begin{lem}[Monotonicity]\label{lem:monotonicity}
  If $\config{S}{e} \parstepsto \config{S'}{e'}$,
  then $\leqstore{S}{S'}$.
\end{lem}
}

\newcommand{\LemIndependence}{
\begin{lem}[Independence]\label{lem:independence}
  If $\config{S}{e} \parstepsto \config{S'}{e'}$ (where
  $\config{S'}{e'} \neq \textup{\error}$), then we have that:
   
  $\config{\lubstore{S}{S''}}{e} \parstepsto \config{\lubstore{S'}{S''}}{e'}$,

  where $S''$ is any store meeting the following conditions:
  \begin{itemize}
    \item $S''$ is non-conflicting with $\config{S}{e} \parstepsto \config{S'}{e'}$,
    \item $\lubstore{S'}{S''} \statuseq S$, and
    \item$\lubstore{S'}{S''} \neq \topS$.
  \end{itemize}
\end{lem}
}

\newcommand{\LemStrongLocalQuasiConfluence}{
\begin{lem}[Strong Local Quasi-Confluence]\label{lem:strong-local-quasi-confluence}
 If $\conf \ctxstepsto \conf_a$ and $\conf \ctxstepsto \conf_b$, then
 either:
  \begin{enumerate}
  \item there exist $\conf_c, i, j, \pi$ such that $\conf_a
    \ctxstepsto^i \conf_c$ and $\pi(\conf_b) \ctxstepsto^j \conf_c$
    and $i \leq 1$ and $j \leq 1$, or
  \item $\conf_a \ctxstepsto \textup{\error}$ or $\conf_b \ctxstepsto
    \textup{\error}$.
  \end{enumerate}
\end{lem}
}

\newcommand{\LemStrongOneSidedQuasiConfluence}{
\begin{lem}[Strong One-Sided Quasi-Confluence]\label{lem:strong-one-sided-quasi-confluence}
  If $\conf \ctxstepsto \conf'$ and $\conf \ctxstepsto^m \conf''$,
  where $1 \leq m$, then either:
  \begin{enumerate}
    \item there exist $\conf_c, i, j, \pi$ such that $\conf'
      \ctxstepsto^i \conf_c$ and $\pi(\conf'') \ctxstepsto^j \conf_c$
      and $i \leq m$ and $j \leq 1$, or
    \item there exists $k \leq m$ such that $\conf' \ctxstepsto^k
      \textup{\error}$, or there exists $k \leq 1$ such that $\conf''
      \ctxstepsto^k \textup{\error}$.
  \end{enumerate}
\end{lem}
}

\newcommand{\LemStrongQuasiConfluence}{
\begin{lem}[Strong Quasi-Confluence]\label{lem:strong-quasi-confluence}
  If $\conf \ctxstepsto^n \conf'$ and $\conf \ctxstepsto^m \conf''$,
  where $1 \leq n$ and $1 \leq m$, then either:
  \begin{enumerate}
    \item there exist $\conf_c, i, j, \pi$ such that $\conf'
      \ctxstepsto^i \conf_c$ and $\pi(\conf'') \ctxstepsto^j \conf_c$
      and $i \leq m$ and $j \leq n$, or
  \item there exists $k \leq m$ such that $\conf' \ctxstepsto^k
    \textup{\error}$, or there exists $k \leq n$ such that $\conf''
    \ctxstepsto^k \textup{\error}$.
  \end{enumerate}
\end{lem}
}

\newcommand{\LemQuasiConfluence}{
\begin{lem}[Quasi-Confluence]\label{lem:quasi-confluence}
  If $\conf \ctxstepsto^* \conf'$ and $\conf \ctxstepsto^* \conf''$,
  then either:
  \begin{enumerate}
  \item there exist $\conf_c$ and $\pi$ such that $\conf'
    \ctxstepsto^* \conf_c$ and $\pi(\conf'') \ctxstepsto^* \conf_c$,
    or
  \item $\conf' = \textup{\error}$ or $\conf'' = \textup{\error}$.
  \end{enumerate}
\end{lem}
\begin{proof}
  Strong Quasi-Confluence (Lemma~\ref{lem:strong-quasi-confluence})
  implies Quasi-Confluence.
\end{proof}
}

\newcommand{\ThmQuasiDeterminism}{
\begin{thm}[Quasi-Determinism]\label{thm:quasi-determinism}
  If $\conf \ctxstepsto^* \conf'$ and $\conf \ctxstepsto^* \conf''$,
  and neither $\conf'$ nor $\conf''$ can take a step, then either:
  \begin{enumerate}
    \item there exists $\pi$ such that $\conf' = \pi(\conf'')$, or
    \item $\conf' = \textup{\error}$ or $\conf'' = \textup{\error}$.
  \end{enumerate}
\end{thm}
\begin{proof}
  By Lemma~\ref{lem:quasi-confluence}, one of the following two cases
  applies:
  \begin{enumerate}
    \item There exists $\conf_c$ and $\pi$ such that $\conf'
      \ctxstepsto^* \conf_c$ and $\pi(\conf'') \ctxstepsto^* \conf_c$.
      Since $\conf'$ cannot step, we must have $\conf' = \conf_c$.

      By Lemma~\ref{lem:permutability} (Permutability), $\conf''$ can
      step iff $\pi(\conf'')$ can step, so since $\conf''$ cannot
      step, $\pi(\conf'')$ cannot step either.

      Hence we must have $\pi(\conf'') = \conf_c$.  Since $\conf' =
      \conf_c$ and $\pi(\conf'') = \conf_c$, $\conf' = \pi(\conf'')$.
    \item $\conf' = \error$ or $\conf'' = \error$, and so the result
      is immediate.
  \end{enumerate}
\end{proof}
}
